<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Printable Sticky Note PDF Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- HTML Meta Tags -->
    <meta name="description" content="Generate perfectly aligned PDFs to print text on your sticky notes.">

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://stickyprinter.app">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Printable Sticky Note PDF Generator">
    <meta property="og:description" content="Generate perfectly aligned PDFs to print text on your sticky notes.">
    <meta property="og:image" content="/og_image.png">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="stickyprinter.app">
    <meta property="twitter:url" content="https://stickyprinter.app">
    <meta name="twitter:title" content="Printable Sticky Note PDF Generator">
    <meta name="twitter:description" content="Generate perfectly aligned PDFs to print text on your sticky notes.">
    <meta name="twitter:image" content="/og_image.png">

  <!-- Favicon: official Material 'note_stack' path, white on black -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23000'/%3E%3Csvg x='8' y='8' width='48' height='48' viewBox='0 -960 960 960' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23FFFFFF' d='M280-160v-441q0-33 24-56t57-23h439q33 0 56.5 23.5T880-600v320L680-80H360q-33 0-56.5-23.5T280-160ZM81-710q-6-33 13-59.5t52-32.5l434-77q33-6 59.5 13t32.5 52l10 54h-82l-7-40-433 77 40 226v279q-16-9-27.5-24T158-276L81-710Zm279 110v440h280v-160h160v-280H360Zm220 220Z'/%3E%3C/svg%3E%3C/svg%3E" />

  <!-- Inter SemiBold + Material Symbols -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" />
  <style>
    :root{
      --bg:#fff;--panel:#f7f7f9;--ink:#0a0a0a;--muted:#666a73;--blue:#2563eb;--blue-dark:#3b82f6;
      --red:#dc2626;--green:#059669;--border:#e7e7ee;--input:#fff
    }
    @media (prefers-color-scheme: dark){
      :root{--bg:#0a0a0a;--panel:#111214;--ink:#f3f4f6;--muted:#a1a1aa;--blue:var(--blue-dark);--border:#23262d;--input:#0f1115}
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Inter",sans-serif}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0000,var(--bg))}
    .brand{width:40px;height:40px;display:grid;place-items:center}
    .brand .material-symbols-rounded{font-size:24px;color:var(--ink)}
    .head{display:flex;flex-direction:column}
    h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}

    .wrap{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px;align-items:start}
    @media (max-width:980px){.wrap{grid-template-columns:1fr}}
    .stack{display:grid;gap:12px;align-content:start}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;align-self:start}
    .card h2{font-size:14px;margin:0 0 10px;letter-spacing:.2px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    label{font-size:13px;color:var(--muted)}
    select{background:var(--input);color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:14px;outline:none}

    /* Buttons */
    button.primary{
      border:1px solid transparent;padding:10px 14px;border-radius:10px;cursor:pointer;background:var(--blue);color:#fff;font-weight:700;font-size:14px;
      display:inline-flex;align-items:center;gap:8px;justify-content:center
    }
    button.primary[disabled]{opacity:.55;cursor:not-allowed}
    button.secondary{
      background:#f3f3f5;color:#444;border:1px solid #d9d9df;border-radius:10px;padding:10px 14px;font-weight:700;font-size:14px;cursor:pointer
    }
    @media (prefers-color-scheme: dark){
      button.secondary{background:#1a1b1e;color:#e5e7eb;border-color:#2a2d33}
    }
    button.secondary[disabled]{opacity:.55;cursor:not-allowed}

    /* File upload */
    .file-upload{position:relative;display:inline-block}
    .file-upload input[type="file"]{position:absolute;left:0;top:0;opacity:0;width:100%;height:100%;cursor:pointer}
    .file-upload label{background:var(--input);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:14px;color:var(--ink);cursor:pointer;display:inline-block}
    #fileArea{display:block;margin-top:4px}
    #loadStatus{display:none;margin-top:4px}
    .file-name{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .file-clear{
      background:transparent;border:none;padding:0;margin:0;cursor:pointer;display:inline-grid;place-items:center;
      width:18px;height:18px;border-radius:4px;color:var(--red);appearance:none;-webkit-appearance:none;
    }
    .file-clear:focus-visible{outline:2px solid var(--red);outline-offset:2px}

    /* Small text buttons in notes header */
    .mini{background:transparent;border:none;padding:0;font:inherit;cursor:pointer;font-weight:600;font-size:13px;letter-spacing:.2px;color:var(--muted)}
    .mini.danger{color:var(--red)}

    /* Segmented control (32x28, 16px icons) */
    .segA{display:inline-flex;gap:3px;padding:3px;border-radius:10px;background:#f7f7f7;border:1px solid #d9d9d9}
    @media (prefers-color-scheme: dark){ .segA{background:#141518;border-color:#2a2d33} }
    .segA button{display:inline-grid;place-items:center;width:32px;height:28px;border-radius:8px;border:1px solid transparent;background:transparent;color:#6b6b6b;cursor:pointer}
    .segA button.active{background:#cfcfcf;border-color:#bdbdbd;color:#111}
    .segA button:hover{background:#efefef;color:#111}
    .segA .material-symbols-rounded{font-size:16px}
    .segA button:focus-visible{outline:2px solid #9a9a9a;outline-offset:2px}

    .card-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px}
    .card-header-right{display:flex;gap:14px;align-items:center}
    .notes{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    @media (max-width:980px){.notes{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.notes{grid-template-columns:1fr}}
    .note{display:grid;gap:6px;padding:10px;border:1px dashed var(--border);border-radius:10px;background:var(--input)}
    .note textarea{
      width:100%;min-height:38px;resize:none;overflow:hidden;background:var(--bg);color:var(--ink);
      border:1px solid var(--border);border-radius:8px;padding:8px;font-size:14px;line-height:1.4
    }
    .note-meta{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
    .ok{color:var(--muted)} .warn{color:var(--red)}
    .adder{display:grid;place-items:center;padding:16px;min-height:72px;border-radius:10px;border:1px dashed var(--border);background:var(--input);cursor:pointer}
    .adder button{background:transparent;border:none;padding:0;font:inherit;color:var(--muted);font-weight:800;font-size:13px;letter-spacing:.2px;cursor:pointer}
    .foot{display:flex;gap:10px;justify-content:space-between;border-top:1px solid var(--border);padding-top:12px;margin-top:12px}

    .gen-row{grid-column:1 / -1;display:flex}
    .gen-row .primary{width:100%}

    hr{border:0;border-top:1px solid var(--border);margin:12px 0 0}
    footer{padding:14px 16px}
    @media (min-width:1024px){ footer{padding-left:32px;padding-right:32px} }
    footer .row{display:flex;justify-content:space-between;align-items:center;margin:0}
    .mini-brand{width:28px;height:28px;display:grid;place-items:center}
    .mini-brand .material-symbols-rounded{font-size:18px;color:var(--ink)}
    .footer-text{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .footer-strong{font-weight:600;color:var(--ink)}
    .success{font-size:13px;color:var(--green);font-weight:700}
    
    /* Liquid glass header on larger screens with subtle fade-in on scroll */
    @media (min-width: 641px) {
      header{
        position: sticky;
        top: 0;
        z-index: 100;
        /* start more transparent at the top; fade in when scrolled */
        background-color: rgba(255,255,255,0.35);
        backdrop-filter: blur(0px);
        -webkit-backdrop-filter: blur(0px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        transition: background-color .25s ease, backdrop-filter .25s ease, box-shadow .25s ease, border-color .25s ease;
      }
      header.scrolled{
        background-color: rgba(255,255,255,0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.06);
        border-bottom-color: rgba(0,0,0,0.08);
      }

      /* Dark mode glass */
      @media (prefers-color-scheme: dark) {
        header{
          background-color: rgba(18,18,18,0.25);
          border-bottom-color: rgba(255,255,255,0.06);
        }
        header.scrolled{
          background-color: rgba(18,18,18,0.6);
          box-shadow: 0 6px 20px rgba(0,0,0,0.35);
          border-bottom-color: rgba(255,255,255,0.12);
        }
      }
    }

    /* Mobile header: sticky + liquid glass + smooth shrink */
    @media (max-width: 640px){
      header{
        position: sticky;
        top: 0;
        z-index: 100;
        padding: 10px 12px; /* a touch more to smooth the transition */
        border-bottom: 1px solid var(--border);

        /* liquid glass */
        background-color: rgba(255,255,255,0.35);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);

        /* smoother animation */
        transition:
          padding .28s cubic-bezier(.25,.8,.25,1),
          background-color .28s cubic-bezier(.25,.8,.25,1),
          backdrop-filter .28s cubic-bezier(.25,.8,.25,1),
          -webkit-backdrop-filter .28s cubic-bezier(.25,.8,.25,1),
          border-color .28s ease,
          box-shadow .28s ease;
        will-change: padding, backdrop-filter, background-color;
      }
      /* dark mode glass */
      @media (prefers-color-scheme: dark){
        header{
          background-color: rgba(18,18,18,0.35);
          border-bottom-color: rgba(255,255,255,0.08);
        }
      }

      /* hide subheader on mobile */
      header .sub{ display:none; }

      /* base sizes at top */
      header .brand{ width:34px; height:34px; transition: width .28s, height .28s; }
      header .brand .material-symbols-rounded{ font-size:20px; transition: font-size .28s; }
      header h1{ font-size:16px; transition: font-size .28s; }

      /* scrolled (compact) */
      header.scrolled{
        padding: 6px 10px;
        background-color: rgba(255,255,255,0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.06);
      }
      @media (prefers-color-scheme: dark){
        header.scrolled{
          background-color: rgba(18,18,18,0.6);
          box-shadow: 0 6px 20px rgba(0,0,0,0.35);
        }
      }
      header.scrolled .brand{ width:28px; height:28px; }
      header.scrolled .brand .material-symbols-rounded{ font-size:18px; }
      header.scrolled h1{ font-size:15px; }
    }



    /* Footer link */
    .footer-link{
      font-size:12px;
      font-weight:600;
      color:var(--muted);
      text-decoration:none;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .footer-link:hover{ text-decoration:underline; }
    
    /* Segmented size picker */
    .sizeSeg { display:inline-flex; gap:6px; align-items:center; }
    .sizeSeg .seg {
      display:inline-flex; gap:4px; padding:3px;
      border:1px solid var(--border); border-radius:10px; background:#f7f7f7;
    }
    @media (prefers-color-scheme: dark){
      .sizeSeg .seg{ background:#141518; border-color:#2a2d33 }
    }
    .sizeSeg .seg button{
      min-width:64px; height:40px; padding:2px 4px;
      border-radius:8px; border:1px solid transparent;
      background:transparent; color:var(--ink);
      font-size:13px; font-weight:600; /* heavier for main labels */
      cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      line-height:1.3;
    }

    /* special case for Auto: center it vertically */
    .sizeSeg .seg button[data-size="auto"]{
      flex-direction:row; /* text centered horizontally & vertically */
      font-weight:600;
    }

    /* sub-label (pt size) lighter weight */
    .sizeSeg .seg button span.sub{
      font-size:12px;
      font-weight:400; /* old weight */
      color:inherit;
      margin-top:-1px;
    }
    .sizeSeg .seg button.active{
      background:#cfcfcf; color:#111; border-color:#bdbdbd;
    }
    #sizeRow, #alignRow {
      gap: 6px; /* space between label and control */
    }
    
    /* Sticky note size selector */
    .noteSize {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
      margin-top: 10px;
    }

    .noteSize h3 {
      margin: 0;
      font-size: 13px;
      line-height: 1.3;
      font-weight: 600;
      color: var(--ink);
    }

    .noteSize .opts {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    /* Option tiles - static like segmented buttons */
    .noteOpt {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      border: 1px solid var(--border);
      background: #141518;
      color: #fff;
      padding: 8px;
      min-height: 64px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      line-height: 1.3;
    }

    /* Main label */
    .noteOpt strong {
      font-size: 13px;
      font-weight: 600; /* match "Small"/"Auto" labels */
    }

    /* Sub-label (pt size) */
    .noteOpt span {
      font-size: 12px;
      font-weight: 400;
    }

    .noteOpt.x3x3 { width: 64px;  height: 64px; }
    .noteOpt.x3x5 { width: 106px; height: 64px; }
    .noteOpt.x4x4 { width: 85px;  height: 85px; }
    .noteOpt.x4x6 { width: 128px; height: 85px; }

    /* Active state */
    .noteOpt[aria-pressed="true"] {
      background: #cfcfcf;
      color: #111;
      border-color: #bdbdbd;
    }

    /* Light theme adjustment */
    @media (prefers-color-scheme: light) {
      .noteOpt:not([aria-pressed="true"]) {
        background: #f3f4f7;
        color: var(--ink);
        border-color: var(--border);
      }
    }

    /* Small screens: keep tiles readable */
    @media (max-width: 480px) {
      .noteOpt.x4x6 { width: 116px; height: 78px; }
      .noteOpt.x4x4 { width: 78px;  height: 78px; }
      .noteOpt.x3x5 { width: 98px;  height: 58px; }
      .noteOpt.x3x3 { width: 60px;  height: 60px; }
    }
    /* 1) Make entry fields 16px (prevents iOS zoom, nicer legibility) */
    .note textarea{
      font-size:16px; /* was 14px */
      line-height:1.4; /* keep your current rhythm */
    }

    /* 2) Segmented controls: darker active in LIGHT MODE with white text */
    /* Text align segmented control */
    @media (prefers-color-scheme: light){
      .segA button.active{
        background:#111;      /* near‑black */
        border-color:#111;
        color:#fff;           /* white text */
      }
    }

    /* Text size segmented control */
    @media (prefers-color-scheme: light){
      .sizeSeg .seg button.active{
        background:#111;
        border-color:#111;
        color:#fff;
      }
    }

    /* (optional) Hover should NOT change color when active */
    .sega button.active:hover,
    .sizeSeg .seg button.active:hover{
      background:inherit;
      color:inherit;
    }


  </style>
</head>
<body>
  <header>
    <div class="brand"><span class="material-symbols-rounded" aria-hidden="true">note_stack</span></div>
    <div class="head">
      <h1>stickyprinter.app</h1>
      <div class="sub">Generate printable PDF templates for 3x3" sticky notes. Create each note individually or import multiple notes via CSV file.</div>
    </div>
  </header>

  <div class="wrap">
    <!-- Left column -->
    <div class="stack">
      <div class="card">
        <h2>Settings</h2>
          <div class="row" id="sizeRow" style="flex-direction:column; align-items:flex-start;">
            <span style="font-size:13px;color:var(--muted);margin-bottom:4px;">Text size</span>

            <!-- hidden select kept for logic -->
            <select id="size" style="display:none">
              <option value="20">Small (20pt)</option>
              <option value="24">Standard (24pt)</option>
              <option value="36">Huge (36pt)</option>
              <option value="auto" selected>Auto (largest possible)</option>
            </select>

            <!-- segmented control -->
            <div class="sizeSeg" role="group" aria-label="Text size">
              <div class="seg" id="sizeSeg">
                <button type="button" data-size="auto" class="active">Auto</button>
                <button type="button" data-size="20">Small<span class="sub">20 pt</span></button>
                <button type="button" data-size="24">Standard<span class="sub">24 pt</span></button>
                <button type="button" data-size="36">Huge<span class="sub">36 pt</span></button>
              </div>
            </div>
          </div>

        <div class="row" id="alignRow" style="flex-direction:column; align-items:flex-start;">
          <span style="font-size:13px;color:var(--muted);">Text align</span>
          <div class="segA" id="alignSeg" role="group" aria-label="Text alignment">
            <button type="button" aria-pressed="false" data-value="left"  title="Left"><span class="material-symbols-rounded">format_align_left</span></button>
            <button type="button" aria-pressed="true"  data-value="center" title="Center" class="active"><span class="material-symbols-rounded">format_align_center</span></button>
            <button type="button" aria-pressed="false" data-value="right" title="Right"><span class="material-symbols-rounded">format_align_right</span></button>
          </div>
        </div>
        <!--
        <div class="noteSize" id="noteSize">
        <span style="font-size:13px;color:var(--muted);">Sticky note size</span>
        <div class="opts" role="group" aria-label="Sticky note size">
          <button type="button" class="noteOpt x3x3" data-size="3x3" aria-pressed="true">
            <strong>Classic</strong><span>3×3”</span>
          </button>
          <button type="button" class="noteOpt x3x5" data-size="3x5" aria-pressed="false">
            <strong>Rectangle</strong><span>3×5”</span>
          </button>
          <button type="button" class="noteOpt x4x4" data-size="4x4" aria-pressed="false">
            <strong>Large</strong><span>4×4”</span>
          </button>
          <button type="button" class="noteOpt x4x6" data-size="4x6" aria-pressed="false">
            <strong>Large Rectangle</strong><span>4×6”</span>
          </button>
        </div>
        </div>
          -->
    </div>

      <div class="card">
        <h2>CSV Import</h2>
        <div class="row">
          <div class="file-upload">
            <label for="csv">Choose CSV file</label>
            <input type="file" id="csv" accept=".csv,text/csv" />
          </div>
          <span id="fileArea" aria-live="polite"></span>
        </div>
        <div class="row"><label><input type="checkbox" id="omitHeader" /> Omit first row</label></div>

        <div class="row" id="loadControls">
          <button id="loadCsv" class="secondary" disabled title="Choose a CSV file to enable loading">Load CSV</button>
          <span id="loadStatus" class="success"></span>
        </div>
      </div>

      <!-- Generate button (full width + icon) -->
      <div class="gen-row">
        <button id="gen" class="primary"><span class="material-symbols-rounded" aria-hidden="true">download</span>Generate PDF</button>
      </div>

      <div class="card">
        <details id="inst" style="font-size:13px;color:var(--muted);line-height:1.5" closed>
          <summary style="cursor:pointer;font-weight:800;color:var(--ink)">Instructions</summary>
          <ul id="instList" style="margin:8px 0 0 18px;padding:0">
            <li>Type your sticky notes here, or upload a CSV (each cell becomes one note).</li>
            <li>Select <strong>Generate PDF</strong> to make your printable notes file.</li>
            <li>
              Download and print the <a href="/templates/3x3-sticky-placement-guide.pdf" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline;">placement guide</a>.
              You’ll need <strong><span id="guidesCount">1</span> placement guide(s)</strong> for your 
              <span id="notesSoFar">0</span> notes.
            </li>
            <li>Stick your 3×3" sticky notes inside the boxes on the placement guide.</li>
            <li>Put those guide pages into your printer’s paper tray or bypass tray. Test print a single page to make sure the orientation is correct.</li>
            <li>Print your generated PDF and enjoy your crisply printed sticky notes!</li>
          </ul>
        </details>
      </div>
    </div>

    <!-- Right column -->
    <div class="card" style="align-self:start">
      <div class="card-header">
        <h2 style="margin:0;">Sticky Notes</h2>
        <div class="card-header-right">
          <button id="createSample" class="mini">Create sample</button>
          <button id="deleteAll" class="mini danger">Delete all</button>
        </div>
      </div>

      <div class="notes" id="notes"></div>

      <div class="foot">
        <span style="font-size:12px;color:var(--muted);" id="countMeta">0 / 300 notes</span>
      </div>
    </div>
  </div>

  <hr>
  <footer>
    <div class="row">
      <div class="footer-text">
        <div class="mini-brand"><span class="material-symbols-rounded" aria-hidden="true">note_stack</span></div>
        <span class="footer-strong">stickyprinter.app</span>
      </div>
      <a class="footer-link" href="https://github.com/evanrussell/stickyprinter" rel="noopener">
        GitHub
      </a>
    </div>
  </footer>


  <!-- libs -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  const PT=72,PAGE={w:8.5*PT,h:11*PT},MARGINS={top:36,bottom:36,left:54,right:54},STICKY={w:3*PT,h:3*PT},GAP={col:72,row:36},INNER_PAD=10;
  function slotRects(){
    const xs=[MARGINS.left,MARGINS.left+STICKY.w+GAP.col];
    const ys=[MARGINS.bottom,MARGINS.bottom+STICKY.h+GAP.row,MARGINS.bottom+(STICKY.h+GAP.row)*2];
    const rects=[]; for(let r=2;r>=0;r--){ for(let c=0;c<2;c++){ rects.push({x:xs[c],y:ys[r],w:STICKY.w,h:STICKY.h}); } } return rects;
  }
  const LIMITS={"20":72,"24":56,"32":30,"36":20,"auto":72};
  const MAX_NOTES=300;

  // --- UI state ---
  const notesEl=document.getElementById('notes');
  const countMeta=document.getElementById('countMeta');
  const guidesCountEl=document.getElementById('guidesCount');
  const notesSoFarEl=document.getElementById('notesSoFar');
  const inputs=[]; let adderEl=null;
  let alignMode='center';

  // segmented control
  const segA=document.getElementById('alignSeg');
  segA.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      segA.querySelectorAll('button').forEach(x=>{x.classList.remove('active');x.setAttribute('aria-pressed','false')});
      btn.classList.add('active'); btn.setAttribute('aria-pressed','true');
      alignMode=btn.dataset.value;
    });
  });

  function updateGuidesHint(){
    const n=inputs.length;
    const pages=Math.ceil(n/6)||0;
    guidesCountEl.textContent=pages;
    notesSoFarEl.textContent=n;
  }

  function updateCountMeta(){
    countMeta.textContent = `${inputs.length} / ${MAX_NOTES} notes`;
    updateGuidesHint();
  }

  function renumber(){ inputs.forEach((n,i)=> n.numEl.textContent=`#${i+1}`); updateCountMeta(); }
  function currentCharLimit(){ return LIMITS[document.getElementById('size').value]||72; }
  function autoResizeTA(ta){ ta.style.height='auto'; ta.style.height=(ta.scrollHeight)+'px'; }

  function createAdder(){
    const card=document.createElement('div'); card.className='adder';
    const btn=document.createElement('button'); btn.type='button'; btn.textContent='+ Sticky Note';
    const add=()=>addNote('');
    btn.addEventListener('click',add);
    card.addEventListener('click', (e)=>{ if(e.target!==btn) add(); }); // whole container clickable
    card.appendChild(btn);
    return card;
  }
  function placeAdder(){
    if(!adderEl) adderEl=createAdder();
    if(adderEl.parentNode) adderEl.parentNode.removeChild(adderEl);
    if(inputs.length<MAX_NOTES) notesEl.appendChild(adderEl);
  }

  function addNote(value=''){
    if(inputs.length>=MAX_NOTES) return;
    const wrap=document.createElement('div'); wrap.className='note';
    const ta=document.createElement('textarea');
    ta.placeholder=`Sticky note ${inputs.length+1}`; ta.value=value; ta.maxLength=currentCharLimit(); autoResizeTA(ta);

    const meta=document.createElement('div'); meta.className='note-meta';
    const num=document.createElement('span'); const cnt=document.createElement('span');
    num.textContent=`#${inputs.length+1}`;
    cnt.textContent=`${(value||'').length} / ${currentCharLimit()}`; cnt.className=((value||'').length>=currentCharLimit())?'warn':'ok';
    meta.appendChild(num); meta.appendChild(cnt);

    ta.addEventListener('input',()=>{
      ta.maxLength=currentCharLimit(); autoResizeTA(ta);
      const n=ta.value.length, max=ta.maxLength; cnt.textContent=`${n} / ${max}`; cnt.className=(n>=max)?'warn':'ok';
    });

    const node={wrap,input:ta,countEl:cnt,numEl:num};
    wrap.appendChild(ta); wrap.appendChild(meta); notesEl.appendChild(wrap);
    inputs.push(node); ta.dispatchEvent(new Event('input')); renumber(); placeAdder();
  }

  function removeAllNotes(){ inputs.forEach(n=>n.wrap.remove()); inputs.length=0; updateCountMeta(); }
  function clearToSixBlank(){
    removeAllNotes(); for(let i=0;i<6;i++) addNote('');
    placeAdder();
    clearCsvSelection();
  }

  // init
  for(let i=0;i<6;i++) addNote(''); placeAdder();


  (function(){
    window.stickyNoteSize = '3x3'; // default

    const group = document.querySelector('#noteSize .opts');
    if(!group) return;

    function setSize(val){
      window.stickyNoteSize = val;
      group.querySelectorAll('.noteOpt').forEach(btn=>{
        btn.setAttribute('aria-pressed', btn.dataset.size === val ? 'true' : 'false');
      });
    }

    group.addEventListener('click', (e)=>{
      const btn = e.target.closest('.noteOpt');
      if(!btn) return;
      setSize(btn.dataset.size);
    });
  })();

  // header actions
  document.getElementById('deleteAll').addEventListener('click',clearToSixBlank);
  document.getElementById('createSample').addEventListener('click',()=>{ removeAllNotes(); for(let i=1;i<=12;i++) addNote(`Sample note #${i}`); placeAdder(); });

  (function(){
    const seg = document.getElementById('sizeSeg');
    const selectEl = document.getElementById('size'); // hidden select for existing logic

    function applySize(value){
      // toggle active state
      seg.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b.dataset.size===value));
      // sync hidden select + trigger your existing handlers
      selectEl.value = value;
      selectEl.dispatchEvent(new Event('change', { bubbles:true }));
    }

    // click handling
    seg.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-size]');
      if(!btn) return;
      applySize(btn.dataset.size);
    });

    // init from current select value (defaults to 'auto' if unset)
    applySize(selectEl.value || 'auto');
  })();

  // size change
  document.getElementById('size').addEventListener('change',()=>{
    const limit=currentCharLimit();
    inputs.forEach(n=>{
      n.input.maxLength=limit;
      if(n.input.value.length>limit) n.input.value=n.input.value.slice(0,limit);
      const len=n.input.value.length; n.countEl.textContent=`${len} / ${limit}`; n.countEl.className=(len>=limit)?'warn':'ok';
      autoResizeTA(n.input);
    });
  });

  // CSV preview / load
  const csvInput=document.getElementById('csv');
  const fileArea=document.getElementById('fileArea'); // single-line region for filename OR success
  const loadBtn=document.getElementById('loadCsv');
  const loadStatus=document.getElementById('loadStatus');

  function showFilenameLine(file){
    fileArea.style.display='block';
    loadStatus.style.display='none';
    fileArea.innerHTML = '';
    if(!file) return;
    const nameWrap=document.createElement('span'); nameWrap.className='file-name';
    const nameText=document.createElement('span'); nameText.textContent=file.name;
    const clearBtn=document.createElement('button');
    clearBtn.type='button'; clearBtn.className='file-clear'; clearBtn.title='Remove file';
    clearBtn.innerHTML = "<span class='material-symbols-rounded' aria-hidden='true' style='font-size:16px'>close_small</span>";
    clearBtn.addEventListener('click', clearCsvSelection);
    nameWrap.appendChild(nameText); nameWrap.appendChild(clearBtn);
    fileArea.appendChild(nameWrap);
  }

  function showSuccessMessage(fileName, addedCount){
    fileArea.style.display='none';
    loadStatus.textContent = `✓ ${fileName} loaded — ${addedCount} notes added`;
    loadStatus.style.display = 'block';
  }

  function resetLoadUI(){
    loadStatus.style.display='none'; loadStatus.textContent='';
    loadBtn.disabled = !(csvInput.files && csvInput.files.length);
    const file = csvInput.files && csvInput.files[0];
    if(file){ showFilenameLine(file); } else { fileArea.style.display='none'; fileArea.innerHTML=''; }
  }

  function clearCsvSelection(){
    csvInput.value = '';
    fileArea.style.display='none'; fileArea.innerHTML='';
    loadStatus.style.display='none'; loadStatus.textContent='';
    loadBtn.disabled = true;
  }

  csvInput.addEventListener('change',()=>{
    const file=csvInput.files && csvInput.files[0];
    if(file){ showFilenameLine(file); }
    else { clearCsvSelection(); }
    loadBtn.disabled = !file;
  });

  loadBtn.addEventListener('click',()=>{
    const file=csvInput.files && csvInput.files[0];
    const omit=document.getElementById('omitHeader').checked;
    if(!file) return;

    Papa.parse(file,{
      complete:(res)=>{
        // Omit entire first row if requested
        const rows = Array.isArray(res.data) ? res.data.slice() : [];
        if(omit && rows.length){ rows.shift(); }

        const flat=[];
        for(const row of rows){
          const arr = Array.isArray(row) ? row : [row];
          for(const cell of arr){ flat.push((cell??'').toString().trim()); }
        }

        const sliced=flat.slice(0,MAX_NOTES);
        removeAllNotes(); const count=Math.max(6, sliced.length);
        for(let i=0;i<count;i++) addNote(sliced[i]??''); placeAdder();

        const added=Math.min(sliced.length,MAX_NOTES);
        showSuccessMessage(file.name, added);
      },
      error:(err)=>alert('CSV parse error: '+err)
    });
  });

  // Generate PDF
  document.getElementById('gen').addEventListener('click',async()=>{
    const { PDFDocument, StandardFonts } = PDFLib;
    const pdf=await PDFDocument.create();
    const interBytes=await fetch("https://fonts.gstatic.com/s/inter/v13/UcCO3Fwr0Cwy8O4N4t6hlvZrQ4Y.woff2").then(r=>r.arrayBuffer()).catch(()=>null);
    let font=null; if(interBytes){ try{ font=await pdf.embedFont(interBytes,{subset:true}); } catch{ font=await pdf.embedFont(StandardFonts.HelveticaBold); } }
    else { font=await pdf.embedFont(StandardFonts.HelveticaBold); }

    const sizeSel=document.getElementById('size').value; const rects=slotRects();
    const all=inputs.map(n=>n.input.value);

    function wrapParagraph(text,font,fontSize,maxWidth){
      const words=(text||'').toString().split(/\s+/); const lines=[]; let line='';
      for(const w of words){ const test=line?line+' '+w:w; const width=font.widthOfTextAtSize(test,fontSize);
        if(width<=maxWidth) line=test;
        else{ if(line) lines.push(line);
          if(font.widthOfTextAtSize(w,fontSize)>maxWidth){ let cur=''; for(const ch of w){ if(font.widthOfTextAtSize(cur+ch,fontSize)<=maxWidth) cur+=ch; else{ if(cur) lines.push(cur); cur=ch; } } line=cur; }
          else line=w;
        }
      } if(line) lines.push(line); return lines;
    }
    function wrapTextByWidthPreserveBreaks(text,font,fontSize,maxWidth){
      const paras=(text||'').toString().split(/\r?\n/); const out=[];
      paras.forEach((p,i)=>{ out.push(...wrapParagraph(p,font,fontSize,maxWidth)); if(i<paras.length-1) out.push(''); }); return out;
    }
    function fitsBox(text,font,fontSize){
      const boxW=STICKY.w-INNER_PAD*2, boxH=STICKY.h-INNER_PAD*2; const lines=wrapTextByWidthPreserveBreaks(text,font,fontSize,boxW); const lh=fontSize*1.2; return (lines.length*lh)<=boxH;
    }
    function pickAutoSize(text,font){
      const order=[36,32,24,20]; const t=(text||'').toString().slice(0,72);
      for(const fs of order) if(fitsBox(t,font,fs)) return {size:fs,text:t}; return {size:20,text:t};
    }

    for(let i=0;i<all.length;i+=6){
      const page=pdf.addPage([PAGE.w,PAGE.h]); const notes=all.slice(i,i+6);
      notes.forEach((text,idx)=>{
        const box=rects[idx]; let t=(text??'').toString(); if(t.length===0) return;
        let fs=sizeSel==='auto'?null:parseInt(sizeSel,10);
        const cap=LIMITS[sizeSel]||72; t=t.slice(0,cap);
        if(sizeSel==='auto'){ const pick=pickAutoSize(t,font); fs=pick.size; t=pick.text; }
        if(sizeSel!=='auto' && !fitsBox(t,font,fs)){ for(const tryFs of [36,32,24,20]){ if(tryFs<=fs && fitsBox(t,font,tryFs)){ fs=tryFs; break; } } }

        const boxW=box.w-INNER_PAD*2; const lines=wrapTextByWidthPreserveBreaks(t,font,fs,boxW); const lh=fs*1.2;
        if(alignMode==='center'){
          const totalH=lines.length*lh; const yStart=box.y+(box.h-totalH)/2+(lines.length-1)*lh;
          lines.forEach((ln,k)=>{ const w=font.widthOfTextAtSize(ln,fs); const x=box.x+(box.w-w)/2; const y=yStart-k*lh; page.drawText(ln,{x,y,size:fs,font}); });
        } else if(alignMode==='left'){
          let y=box.y+box.h-INNER_PAD-fs; const x=box.x+INNER_PAD; lines.forEach((ln,k)=>{ page.drawText(ln,{x,y:y-k*lh,size:fs,font}); });
        } else {
          let y=box.y+box.h-INNER_PAD-fs; lines.forEach((ln,k)=>{ const w=font.widthOfTextAtSize(ln,fs); const x=box.x+box.w-INNER_PAD-w; const yy=y-k*lh; page.drawText(ln,{x,y:yy,size:fs,font}); });
        }
      });
    }

    const bytes=await pdf.save(); const blob=new Blob([bytes],{type:'application/pdf'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='sticky-notes.pdf'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),10000);
  });

  // Keep the guides count accurate at init
  updateGuidesHint();


  // Subtle fade-in of the glass header when scrolling
  (function(){
    const hdr = document.querySelector('header');
    if(!hdr) return;
    const onScroll = () => {
      // add a small threshold so it doesn't flicker at the very top
      if (window.scrollY > 8) hdr.classList.add('scrolled');
      else hdr.classList.remove('scrolled');
    };
    window.addEventListener('scroll', onScroll, { passive: true });
    // initialize on load (in case the page is refreshed mid-scroll)
    onScroll();
  })();
  </script>
</body>
</html>